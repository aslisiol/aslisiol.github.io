---
import MainLayout from '../layouts/MainLayout.astro';
import fs from 'fs/promises';
import path from 'path';
import { marked } from 'marked';
import PhotoGrid from '../components/PhotoGrid.astro';
import imageDataRaw from '../../public/gallery/professional_work/metadata.json';

interface ImageMeta {
	url: string;
	link: string;
	title?: string;
	description?: string;
	markdownPath?: string;
	markdown?: string;
}

interface ImageData {
	[filename: string]: ImageMeta;
}

const imageData = imageDataRaw as ImageData;

const images = await Promise.all(
	Object.keys(imageData).map(async (filename) => {
		const data = imageData[filename];
		let markdownHtml = '';

		if (data.markdownPath) {
			const mdFilePath = path.resolve('./src/content/markdown', data.markdownPath);
			const mdRaw = await fs.readFile(mdFilePath, 'utf-8'); // await here!
			markdownHtml = await marked(mdRaw);
		}

		return {
			...data,
			url: `${import.meta.env.BASE_URL}${data.url}`,
  			link: `${import.meta.env.BASE_URL}${data.link}`,
			markdown: markdownHtml,
		};
	}),
);
---

<style>
	#box {
		width: 100%;
		overflow: auto;
		display: flex;
		justify-content: center;
		align-items: center;
		margin-left: auto;
		margin-right: auto;
	}
</style>

<MainLayout>
	<section id="box" class="py-20">
		<PhotoGrid images={images} default_size={3} />
	</section>
</MainLayout>
